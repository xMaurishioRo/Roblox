<html><head><meta charset="UTF-8"><title>[miau]</title><style>body,html{margin:0;padding:0;height:100%}body{color:#fff;background-color:#000;display:flex;align-items:center;justify-content:center;overflow:hidden}canvas{flex-shrink:0;background-color:#000;object-fit:contain}.crisp{image-rendering:-moz-crisp-edges;image-rendering:-webkit-crisp-edges;image-rendering:pixelated}</style><script>window.console=window.console||function(o){}</script></head><body translate="no" oncontextmenu="return!1" onkeydown='if(event.ctrlKey&&("u"===event.key||"s"===event.key||"i"===event.key))return!1'><script id="rendered-js">Util={},Util.timeStamp=function(){return window.performance.now()},Util.random=function(t,e){return t+Math.random()*(e-t)},Util.array2D=function(t,e){for(var i=[],s=0;s<t.length;s+=e)i.push(t.slice(s,s+e));return i},Util.toDio=function(t){let e=t.map(t=>0!==t?t-1:t),i=Util.array2D(e,16);return JSON.stringify(i)},Util.map=function(t,e,i,s,o){return(t-e)/(i-e)*(o-s)+s},Util.lerp=function(t,e,i){return t+(e-t)*i},Util.linearTween=function(t,e,i,s){return i*t/s+e},Util.easeInOutQuad=function(t,e,i,s){return(t/=s/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e},Util.easeInOutExpo=function(t,e,i,s){return(t/=s/2)<1?i/2*Math.pow(2,10*(t-1))+e:(t--,i/2*(2-Math.pow(2,-10*t))+e)};class Scene{constructor(t){this.name=t,this.loop=!0,this.init_once=!1}giveWorld(t){this.world=t,this.ctx=t.ctx}keyEvents(t){}init(){}render(){}addEntity(){}}class Entity{constructor(t,e,i){this.scene=t,this.world=t.world,this.ctx=this.world.ctx,this.body=new Body(this,e,i)}setSprite(t){this.sprite=new Sprite(this,t)}display(){void 0===this.sprite?(this.ctx.strokeStyle="#000",this.ctx.strokeRect(this.body.position.x,this.body.position.y,this.body.size.x,this.body.size.y)):this.sprite.display()}integration(){this.body.integration()}}class Sprite{constructor(t,e){this.entity=t,this.world=this.entity.world,this.tile_size=this.world.tile_size,this.ctx=this.world.ctx,this.image=this.world.assets.image[e.image].image,this.size=e.size,this.current_frame=0,this.animations={},this.current_animation=void 0,this.width=this.image.width/this.size.x,this.height=this.image.height/this.size.y,this.tick=0,this.speed=.2,this.offset={x:0,y:0}}addAnimation(t,e){this.animations[t]=e,this.current_animation=t}animate(t){this.current_animation=t,this.tick<1?this.tick+=this.speed:(this.tick=0,this.current_frame<this.animations[t].length-1?this.current_frame+=1:this.current_frame=0)}display(){this.ctx.drawImage(this.image,Math.floor(this.animations[this.current_animation][this.current_frame]%this.width)*this.size.x,Math.floor(this.animations[this.current_animation][this.current_frame]/this.width)*this.size.y,this.size.x,this.size.y,this.entity.body.position.x+(this.tile_size/2-this.size.x/2)+this.offset.x,this.entity.body.position.y+(this.tile_size/2-this.size.x/2)+this.offset.y,this.size.x,this.size.y)}}class Body{constructor(t,e,i){this.world=t.world,this.step=this.world.FPS.step,this.position=new Vector(e,i),this.next_position=new Vector(e,i),this.velocity=new Vector(0,0),this.stepped_velocity=new Vector(0,0),this.acceleration=new Vector(0,0),this.drag=.98,this.size={x:16,y:16}}setSize(t,e){this.size.x=t,this.size.y=e}updateVelocity(){this.velocity.add(this.acceleration),this.velocity.mult(this.drag),this.stepped_velocity=this.velocity.copy(),this.stepped_velocity.mult(this.step),this.next_position=this.position.copy(),this.next_position.add(this.stepped_velocity),this.acceleration.mult(0)}updatePosition(){this.position.add(this.stepped_velocity)}integration(){this.updateVelocity(),this.updatePosition()}applyForce(t){this.acceleration.add(t)}}class Vector{constructor(t,e){this.x=t||0,this.y=e||0}set(t,e){this.x=t,this.y=e}add(t){this.x+=t.x,this.y+=t.y}sub(t){this.x-=t.x,this.y-=t.y}mult(t){this.x*=t,this.y*=t}div(t){this.x/=t,this.y/=t}limit(t){this.mag()>t&&this.setMag(t)}mag(){return Math.hypot(this.x,this.y)}setMag(t){this.mag()>0?this.normalize():(this.x=1,this.y=0),this.mult(t)}dist(t){return new Vector(this.x-t.x,this.y-t.y).mag()}normalize(){let t=this.mag();t>0&&(this.x/=t,this.y/=t)}heading(){return Math.atan2(this.x,this.y)}setHeading(t){let e=this.mag();this.x=Math.cos(t)*e,this.y=Math.sin(t)*e}copy(){return new Vector(this.x,this.y)}}class Box{constructor(t,e){this.world=t,this.ctx=t.ctx,this.c_ctx=t.c_ctx,this.box_data=e,this.resolution=e.resolution,this.image=t.assets.image[e.image].image}display(t,e,i,s){this.ctx.fillRect(t+1,e+1,i-2,s-2),this.ctx.lineWidth=2;for(let o=0;o<4;o++){let a=t+Math.floor(o%2)*(i-this.resolution),r=e+Math.floor(o/2)*(s-this.resolution),n=Math.floor(o%2)*(2*this.resolution),h=Math.floor(o/2)*(2*this.resolution);this.ctx.drawImage(this.image,n,h,this.resolution,this.resolution,a,r,this.resolution,this.resolution)}let o=3*this.resolution;this.ctx.drawImage(this.image,8,0,this.resolution,this.resolution,t+8,e,this.resolution+i-o,this.resolution),this.ctx.drawImage(this.image,8,16,this.resolution,this.resolution,t+8,e+s-this.resolution,this.resolution+i-o,this.resolution),this.ctx.drawImage(this.image,0,8,this.resolution,this.resolution,t,e+8,this.resolution,this.resolution+s-o),this.ctx.drawImage(this.image,16,8,this.resolution,this.resolution,t+i-this.resolution,e+this.resolution,this.resolution,this.resolution+s-o)}}class Diorama{constructor(t){this.parameters=t,this.background_color=t.background_color||"#000",this.initCanvas(t),this.counter=0,this.toLoad=t.assets.length,this.assets={image:{},audio:{}},this.audio_muted=!1,this.keys={},this.scenes={},this.start_screen=t.start_screen||void 0,this.current_scene="",this.alphabet="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789 ?!:',.()<>[]",this.fonts={},this.tile_size=t.tile_size||16,this.tiles_data={},void 0!==t.tiles&&t.tiles.map(t=>{this.tiles_data[t.id]=t}),this.mapsMax=t.maps.length,this.maps={},void 0!==t.maps&&t.maps.map(t=>{this.maps[t.name]=t}),this.boxes={},this.currentFont=void 0,this.FPS={now:0,delta:0,last:Util.timeStamp(),step:1/(t.frame_rate||60)},this.requestChange={value:!1,action:""},this.main_loop=void 0}ready(){this.loadAssets(this.parameters.assets)}initCanvas(t){this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.W=this.canvas.width=t.width||256,this.H=this.canvas.height=t.height||256,this.scale=t.scale||1,this.full=!1,this.ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("crisp"),document.body.appendChild(this.canvas),this.cache=document.createElement("canvas"),this.c_ctx=this.cache.getContext("2d")}loader(){this.clear("#222"),this.counter+=1;let t=this.W-40,e=this.H-40;this.ctx.fillStyle="#111",this.ctx.fillRect(20,e,t,20),this.ctx.fillStyle="#333",this.ctx.fillRect(20,e,this.counter*t/this.toLoad,20),this.ctx.strokeStyle="#000",this.ctx.lineWidth=4,this.ctx.strokeRect(20,e,t,20),this.counter===this.toLoad&&this.launch()}loadAssets(t){void 0===t&&console.log("Nothing to load"),t.map(t=>this.checkAssets(t))}checkAssets(t){let e=t;switch(t.type){case"img":let i=new Image;i.onload=()=>{this.loader()},i.onerror=()=>{console.log("can't load Image: "+t.name)},i.src=t.path,e.image=i,this.assets.image[t.name]=e;break;case"audio":let s=new Audio(t.path);s.addEventListener("canplaythrough",this.loader()),s.onerror=()=>{console.log("can't load audio: "+t.name)},e.audio=s,this.assets.audio[t.name]=e;break;case void 0:console.log(t.name," doesn't have any type");break;default:console.log(t.name," has a none known type")}}launch(){this.eventSetup(),this.initBoxes(this.parameters.boxes),this.initFonts(this.parameters.fonts),this.startScene(this.start_screen)}initBoxes(t){if(void 0===t)return!1;t.map(t=>{this.boxes[t.name]=new Box(this,t)})}drawBox(t,e,i,s,o){this.boxes[t].display(e,i,s,o)}setFont(t){this.currentFont=t}initFonts(t){if(void 0===t&&t.length>0)return!1;t.map(t=>{if(void 0===this.assets.image[t.image])return console.log("can't load font, "+t.image+" doesn't exist"),!1;t.image=this.assets.image[t.image].image,this.fonts[t.name]=t}),this.currentFont=Object.keys(this.fonts)[0]}write(t,e,i,s,o){if(void 0===this.currentFont)return console.log("No bitmap_font"),!1;if("string"==typeof s){switch(s){case"center":e-=t.length*this.fonts[this.currentFont].size.x/2;break;case"right":e-=t.length*this.fonts[this.currentFont].size.x}this.writeLine(t,e,i,o||0)}else this.writeParagraph(t,e,i,s,o||0)}writeParagraph(t,e,i,s,o){let a=0,r=this.fonts[this.currentFont].size.y+5,n=this.fonts[this.currentFont].size.x,h=t.split(" "),l="";for(let t=0;t<h.length;t++){l+=h[t]+" ";let c=0,d=h[t+1],m=l.length*n;d&&(c=d.length*n),m+c>s?(this.writeLine(l,e,i+a,0,o),a+=r,l=""):this.writeLine(l,e,i+a,0,o)}}writeLine(t,e,i,s){let o=this.fonts[this.currentFont].size.x,a=this.fonts[this.currentFont].size.y,r=this.fonts[this.currentFont].image;for(let n=0;n<t.length;n++){let h=o*this.alphabet.indexOf(t.charAt(n)),l=e+n*o;this.ctx.drawImage(r,h,s*a,o,a,l,i,o,a)}}eventSetup(){document.addEventListener("keydown",t=>this.keyDown(t),!1),document.addEventListener("keyup",t=>this.keyUp(t),!1)}keyDown(t){t.preventDefault(),this.keys[t.code]=!0,this.keys.KeyF&&this.fullScreen(),this.keys.KeyM&&this.mute(),this.current_scene.keyEvents(t)}keyUp(t){t.preventDefault(),this.keys[t.code]=!1}startScene(t){return void 0===this.scenes[t]?t+" - doesn't exist":void 0!==this.main_loop?(this.requestChange.value=!0,this.requestChange.action=t,!1):(this.requestChange.value=!1,this.requestChange.action="",this.FPS.last=Util.timeStamp(),this.current_scene=this.scenes[t],this.initScene(),void(!0===this.current_scene.loop?this.gameLoop():this.mainRender()))}initScene(){if(this.current_scene.init_once)return!1;this.current_scene.init()}addScene(t){t.giveWorld(this),this.scenes[t.name]=t}mainRender(){this.clear(),this.current_scene.render()}loopCheck(){!1===this.requestChange.value?this.main_loop=requestAnimationFrame(()=>this.gameLoop()):(cancelAnimationFrame(this.main_loop),this.main_loop=void 0,this.startScene(this.requestChange.action))}gameLoop(){for(this.FPS.now=Util.timeStamp(),this.FPS.delta+=Math.min(1,(this.FPS.now-this.FPS.last)/1e3);this.FPS.delta>this.FPS.step;)this.FPS.delta-=this.FPS.step,this.mainRender();this.FPS.last=this.FPS.now,this.loopCheck()}soundLevel(t){for(let[e,i]of Object.entries(this.assets.audio))i.audio.volume=t}mute(){this.audio_muted=!this.audio_muted;for(let[t,e]of Object.entries(this.assets.audio))e.audio.muted=this.audio_muted}clear(t){this.ctx.fillStyle=t||this.background_color,this.ctx.fillRect(0,0,this.W,this.H)}setScale(){this.canvas.style.width=this.W*this.scale+"px",this.canvas.style.height=this.H*this.scale+"px"}fullScreen(){this.full=!this.full,this.full?(this.canvas.style.width="100%",this.canvas.style.height="100%"):this.setScale()}getTile(t,e,i){if(e<0||e>this.terrain.layers[t].size.x-1)return!1;if(i<0||i>this.terrain.layers[t].size.y-1)return!1;let s=this.tiles_data[this.terrain.layers[t].geometry[i][e]];return void 0!==s&&s}findTile(t,e){let i=this.terrain.layers[t],s=[];for(let t=0;t<i.size.y;t++)for(let o=0;o<i.size.x;o++){i.geometry[t][o]===e&&s.push({x:o,y:t})}return s}initMap(t){this.terrain=JSON.parse(JSON.stringify(this.maps[t]));for(var e=0;e<this.terrain.layers.length;e++)this.terrain.layers[e].size={x:this.terrain.layers[e].geometry[0].length,y:this.terrain.layers[e].geometry.length};this.terrain.tileset=this.assets.image[this.maps[t].tileset].image,this.terrain.tileset_size={width:this.terrain.tileset.width/this.tile_size,height:this.terrain.tileset.height/this.tile_size+1},this.terrain.layers.forEach((t,e)=>{for(var i in this.marchingSquare(t),this.bitMasking(t),this.terrainCache(t),t.animated=[],this.tiles_data)if(!0===this.tiles_data[i].animated){let s=this.findTile(e,parseInt(i));t.animated.push({id:i,spritesheet:this.assets.image[this.tiles_data[i].spritesheet].image,positions:s,current:0,steps:this.tiles_data[i].steps,max_frame:this.assets.image[this.tiles_data[i].spritesheet].image.width/this.tile_size})}}),this.clear("black")}terrainCache(t){t.cache={};let e=t.cache.c=document.createElement("canvas"),i=t.cache.ctx=t.cache.c.getContext("2d"),s=e.width=t.size.x*this.tile_size,o=e.height=t.size.y*this.tile_size;this.ctx.clearRect(0,0,s,o),this.drawLayer(t),i.drawImage(this.canvas,0,0),this.clear()}marchingSquare(t){t.square=[];for(let e=0;e<t.size.y;e++)for(let i=0;i<t.size.x;i++){let s=0,o=0,a=0,r=0;e+1<t.size.y&&i+1<t.size.x&&(s=t.geometry[e][i],o=t.geometry[e][i+1],a=t.geometry[e+1][i+1],r=t.geometry[e+1][i]);let n=8*s+4*o+2*a+r;t.square.push(n)}t.square=Util.array2D(t.square,t.size.x)}bitMasking(t){t.bitMask=[];for(let e=0;e<t.size.y;e++)for(let i=0;i<t.size.x;i++){let s=t.geometry[e][i],o=[0,0,0,0];e-1>-1?s===t.geometry[e-1][i]&&(o[0]=1):o[0]=1,i-1>-1?s===t.geometry[e][i-1]&&(o[1]=1):o[1]=1,i+1<t.size.x?s===t.geometry[e][i+1]&&(o[2]=1):o[2]=1,e+1<t.size.y?s===t.geometry[e+1][i]&&(o[3]=1):o[3]=1,s=1*o[0]+2*o[1]+4*o[2]+8*o[3],t.bitMask.push(s)}t.bitMask=Util.array2D(t.bitMask,t.size.x)}renderMap(){this.terrain.layers.forEach(t=>{this.ctx.drawImage(t.cache.c,0,0),t.animated.forEach(t=>{t.current<t.max_frame-1?t.current+=t.steps:t.current=0,t.positions.forEach(e=>{let i=e.x*this.tile_size,s=e.y*this.tile_size;this.ctx.drawImage(t.spritesheet,Math.floor(t.current)*this.tile_size,0,this.tile_size,this.tile_size,i,s,this.tile_size,this.tile_size)})})})}drawMap(){this.terrain.layers.forEach(t=>{this.drawLayer(t)})}drawLayer(t){for(let e=0;e<t.size.y;e++)for(let i=0;i<t.size.x;i++){let s=t.geometry[e][i],o=i*this.tile_size+t.offset.x,a=e*this.tile_size+t.offset.y,r=Math.floor(s%this.terrain.tileset_size.width)*this.tile_size,n=Math.floor(s/this.terrain.tileset_size.width)*this.tile_size;if(this.tiles_data[s]&&"bitmask"===this.tiles_data[s].look&&(r=Math.floor(t.bitMask[e][i])*this.tile_size,n=this.tiles_data[s].line*this.tile_size),"square"===t.look){if(0===t.square[e][i])continue;o+=this.tile_size/2,a+=this.tile_size/2,r=16*Math.floor(t.square[e][i]%16),n=7*this.tile_size}this.tiles_data[s]&&!0===this.tiles_data[s].animated||this.ctx.drawImage(this.terrain.tileset,r,n,this.tile_size,this.tile_size,o,a,this.tile_size,this.tile_size)}}}let parameters={name:"Demo",start_screen:"menu",background_color:"#223d8c",width:256,height:256,tile_size:16,assets:[{type:"img",name:"coderscrux_font",path:"https://image.ibb.co/fCOd7T/coderscrux_font.png"},{type:"img",name:"controls",path:"https://image.ibb.co/nApwu8/controls.png"},{type:"img",name:"player_sprite",path:"https://image.ibb.co/co3NZ8/player.png"},{type:"img",name:"spawn_effect",path:"https://image.ibb.co/njVQnT/spawn_effect.png"},{type:"img",name:"water_splash",path:"https://image.ibb.co/jm7hZ8/water_splash.png"},{type:"img",name:"shadow",path:"https://image.ibb.co/djchZ8/shadow.png"},{type:"img",name:"main_title",path:"https://i.ibb.co/FqVwtGjG/img.png"},{type:"img",name:"origami_dark",path:"https://image.ibb.co/gzk2Z8/origami_dark.png"},{type:"img",name:"origami_light",path:"https://image.ibb.co/jruknT/origami_light.png"},{type:"img",name:"box_texture",path:"https://image.ibb.co/kpO0Mo/box.png"},{type:"img",name:"selection",path:"https://image.ibb.co/fmJpE8/selection.png"},{type:"img",name:"flat_frame",path:"https://image.ibb.co/hqSugo/flat_frame.png"},{type:"img",name:"pattern",path:"https://image.ibb.co/cv02Z8/pattern.png"},{type:"img",name:"cursor",path:"https://image.ibb.co/bFiNZ8/cursor.png"},{type:"img",name:"demo_tileset",path:"https://image.ibb.co/b8rLMo/demo_tileset.png"},{type:"img",name:"exit",path:"https://image.ibb.co/esCS1o/exit.png"},{type:"img",name:"water_sprite",path:"https://image.ibb.co/cSFEgo/water_sprite.png"},{type:"img",name:"dust_effect",path:"https://image.ibb.co/mKy0Mo/dust.png"},{type:"audio",name:"jingle",path:"http://www.noiseforfun.com/waves/musical-and-jingles/NFF-bravo.wav"},{type:"audio",name:"mouvement",path:"http://www.noiseforfun.com/waves/interface-and-media/NFF-select-04.wav"},{type:"audio",name:"selection",path:"http://www.noiseforfun.com/waves/interface-and-media/NFF-select.wav"},{type:"audio",name:"apparition",path:"http://www.noiseforfun.com/waves/interface-and-media/NFF-bubble-input.wav"},{type:"audio",name:"eboulement",path:"http://www.noiseforfun.com/waves/action-and-game/NFF-moving-block.wav"},{type:"audio",name:"splash",path:"http://www.noiseforfun.com/waves/action-and-game/NFF-mud-splash.wav"},{type:"audio",name:"bump",path:"http://www.noiseforfun.com/waves/action-and-game/NFF-bump.wav"}],fonts:[{name:"coderscrux",image:"coderscrux_font",size:{x:6,y:9}},{name:"origami_dark",image:"origami_dark",size:{x:8,y:9}},{name:"origami_light",image:"origami_light",size:{x:8,y:9}}],boxes:[{name:"box",resolution:8,image:"box_texture"},{name:"selection",resolution:8,image:"selection"},{name:"flat_frame",resolution:8,image:"flat_frame"}],tiles:[{name:"empty",id:0,collision:!1,visibility:!1},{name:"water",id:1,collision:!1,look:"square",line:7},{name:"shores",id:2,collision:!1,look:"bitmask",line:6},{name:"ground",id:3,collision:!1,look:"bitmask",line:1},{name:"wall",id:4,collision:!0,look:"bitmask",line:2},{name:"fence",id:11,collision:!0,look:"bitmask",line:4},{name:"bush",id:5,collision:!0},{name:"ice",id:6,collision:!1,look:"bitmask",line:3},{name:"spawn",id:7,collision:!1},{name:"exit",id:8,collision:!1,animated:!0,spritesheet:"exit",steps:.4},{name:"waves",id:16,collision:!1,animated:!0,spritesheet:"water_sprite",steps:.2},{name:"trap",id:9,collision:!1},{name:"hole",id:10,collision:!0},{name:"arrowLeft",id:12,collision:!1},{name:"arrowUp",id:13,collision:!1},{name:"arrowRight",id:14,collision:!1},{name:"arrowDown",id:15,collision:!1}],maps:[{name:"map_1",tileset:"demo_tileset",layers:[{name:"ground",offset:{x:0,y:4},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,3,3,3,0,0,0,0,0,0,0,0,0,0,0],[0,0,3,3,0,0,0,3,3,3,3,3,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,3,3,3,0,0],[0,0,0,0,0,0,3,3,3,3,3,3,3,3,0,0],[0,0,0,0,0,0,0,3,3,3,3,3,3,0,0,0],[0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0],[0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0],[0,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},{name:"onGround",offset:{x:0,y:0},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,11,11,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,11,0,0,0,0],[0,0,0,0,0,0,0,8,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,5,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0],[0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,5,5,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}]},{name:"map_2",tileset:"demo_tileset",layers:[{name:"ground",offset:{x:0,y:4},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,0,0,3,3,3,3,3,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},{name:"onGround",offset:{x:0,y:0},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,11,11,11,11,11,0,0,11,11,11,11,11,0,0],[0,0,11,0,0,0,11,0,0,11,0,0,0,11,0,0],[0,0,11,0,8,0,11,0,0,11,0,8,0,11,0,0],[0,0,11,0,0,0,11,0,0,11,0,0,0,11,0,0],[0,0,11,0,0,0,11,0,0,11,0,0,0,11,0,0],[0,0,11,4,4,0,11,0,0,11,0,0,0,11,0,0],[0,0,11,0,0,0,11,0,0,11,0,4,4,11,0,0],[0,0,11,0,0,0,11,0,0,11,0,0,0,11,0,0],[0,0,11,0,7,0,11,0,0,11,0,7,0,11,0,0],[0,0,11,11,11,11,11,0,0,11,11,11,11,11,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}]},{name:"map_3",tileset:"demo_tileset",layers:[{name:"ground",offset:{x:0,y:4},geometry:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,0,0,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]]},{name:"onGround",offset:{x:0,y:0},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,4,4,4,4,4,0,0,4,4,4,4,4,0,0],[0,0,4,0,0,0,0,0,0,0,0,0,0,4,0,0],[0,0,4,0,0,0,0,0,0,0,0,0,0,4,0,0],[0,0,4,0,0,0,0,0,0,0,8,0,0,4,0,0],[0,0,4,0,0,0,0,0,0,0,0,0,0,4,0,0],[0,0,4,8,0,0,0,0,0,0,5,0,0,4,0,0],[0,0,4,0,0,0,0,0,0,0,0,0,0,4,0,0],[0,0,4,11,11,0,0,0,0,0,0,0,0,4,0,0],[0,0,4,7,0,0,0,0,0,0,0,7,0,4,0,0],[0,0,4,4,4,4,4,0,0,4,4,4,4,4,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}]},{name:"map_4",tileset:"demo_tileset",layers:[{name:"ground",offset:{x:0,y:4},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,3,3,3,3,0,0,0,0],[0,0,0,0,0,3,3,3,3,3,3,3,3,0,0,0],[0,0,0,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,3,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,3,0,0,0],[0,0,3,3,3,3,3,3,3,3,3,3,0,0,0,0],[0,0,0,3,3,3,3,3,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]},{name:"onGround",offset:{x:0,y:0},geometry:[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,11,11,11,0,0,0],[0,0,0,0,0,0,0,0,0,0,11,0,11,0,0,0],[0,0,0,0,11,11,11,0,0,0,11,0,11,0,0,0],[0,0,0,0,11,0,11,0,0,0,11,0,11,0,0,0],[0,0,0,0,11,0,11,0,0,0,11,9,11,0,0,0],[0,0,0,0,11,8,11,0,0,0,11,8,11,0,0,0],[0,0,0,0,11,0,11,0,0,0,11,7,11,0,0,0],[0,0,0,0,11,0,11,0,0,0,11,0,11,0,0,0],[0,0,0,0,11,0,11,5,0,0,11,11,11,0,0,0],[0,0,0,0,11,7,11,0,0,0,0,0,0,0,0,0],[0,0,0,0,11,11,11,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]]}]},{name:"map_5",tileset:"demo_tileset",layers:[{name:"ground",offset:{x:0,y:4},geometry:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]]},{name:"onGround",offset:{x:0,y:0},geometry:[[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,0,5,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,0,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,5,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,5,6,4,4,4],[4,4,4,6,6,6,6,6,4,6,6,6,6,8,4,4],[4,4,4,6,6,4,6,6,4,6,4,4,6,4,4,4],[4,4,4,4,6,6,6,6,4,6,6,6,6,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,5,6,6,6,6,0,0,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,0,7,4,4,4],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,0,4],[4,5,0,4,4,4,4,4,4,4,4,4,4,4,0,4],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4]]}]},{name:"map_6",tileset:"demo_tileset",layers:[{name:"ground",offset:{x:0,y:4},geometry:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]]},{name:"onGround",offset:{x:0,y:0},geometry:[[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,4,4,6,6,14,0,6,6,6,6,15,4,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,8,6,6,6,4,6,6,4,4,4],[4,4,4,0,6,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,7,6,4,4,4],[4,4,4,11,11,11,11,11,11,11,11,11,11,4,4,4],[4,4,4,6,6,14,6,6,6,6,6,6,4,4,4,4],[4,4,4,6,6,6,6,6,6,6,0,6,4,4,4,4],[4,4,4,6,6,0,6,6,6,6,6,6,6,4,4,4],[4,4,4,6,6,6,6,6,6,6,6,8,13,4,4,4],[4,4,4,6,6,6,7,6,6,6,6,6,6,4,4,4],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4],[4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4]]}]}]};parameters.maps.forEach(t=>{new_layer={},new_layer.name="water",new_layer.look="square",new_layer.offset={x:0,y:8},new_layer.geometry=Array(16).fill().map(()=>Array(16).fill(0)),t.layers.unshift(new_layer),new_layer={},new_layer.name="splash",new_layer.offset={x:0,y:8},new_layer.geometry=Array(16).fill().map(()=>Array(16).fill(0)),t.layers.splice(2,0,new_layer);let e=t.layers[0],i=t.layers[1],s=t.layers[2];for(let t=0;t<i.geometry.length;t++)for(let e=0;e<i.geometry[0].length;e++)t-1>0&&3!==i.geometry[t][e]&&3==i.geometry[t-1][e]&&(i.geometry[t][e]=2);for(let t=0;t<i.geometry.length;t++)for(let e=0;e<i.geometry[0].length;e++)2==i.geometry[t][e]&&(s.geometry[t][e]=16);for(let t=0;t<e.geometry.length;t++)for(let s=0;s<e.geometry[0].length;s++)3==i.geometry[t][s]&&(e.geometry[t][s]=1),3!==i.geometry[t][s]&&3==i.geometry[t][s+1]&&(e.geometry[t][s]=1),3!==i.geometry[t][s]&&3==i.geometry[t][s-1]&&(e.geometry[t][s]=1),t+1<e.geometry.length&&3!==i.geometry[t][s]&&3==i.geometry[t+1][s]&&(e.geometry[t][s]=1),t-1>0&&3!==i.geometry[t][s]&&3==i.geometry[t-1][s]&&(e.geometry[t][s]=1);for(let t=0;t<e.geometry.length;t++)for(let i=0;i<e.geometry[0].length;i++)-1==e.geometry[t][i]&&(e.geometry[t][i]=1)});let menu=new Scene("menu");menu.keyEvents=function(t){this.world.keys.ArrowDown&&this.selection<this.button.length-1?(this.world.assets.audio.selection.audio.play(),this.selection+=1):this.world.keys.ArrowUp&&this.selection>0&&(this.world.assets.audio.selection.audio.play(),this.selection-=1),this.world.keys.KeyX&&(this.world.assets.audio.selection.audio.play(),this.world.startScene(this.button[this.selection].link))},menu.init=function(){this.init_once=!0,this.button=[{name:"PLAY",link:"inGame"},{name:"SELECT",link:"levels"},{name:"CONTROLS",link:"controls"}],this.texteMax=6*Math.max(...this.button.map(t=>t.name.length)),this.selection=0,this.select_pos={x:this.world.W/2,y:110},this.cursor_phase=0,this.cursor=this.world.assets.image.cursor.image;let t=this.world.assets.image.pattern.image;this.pattern=this.world.ctx.createPattern(t,"repeat"),this.offset={x:0,y:0},this.cat=new Entity(this,-this.world.tile_size,-this.world.tile_size);this.cat.setSprite({image:"player_sprite",size:{x:18,y:18}}),this.cat.sprite.addAnimation("idle",[0,1,2,3,4,5,6,7,8,9,10,11]),this.cat.sprite.speed=.2,this.cat.sprite.offset.y=-3},menu.render=function(){if(this.animatedBackground(),!this._marioLogoImg){let t='\n    <svg width="220" height="70" viewBox="0 0 220 70" xmlns="http://www.w3.org/2000/svg">\n      <defs>\n        <linearGradient id="marioRed" x1="0%" y1="0%" x2="100%" y2="100%">\n          <stop offset="0%" stop-color="#ff3c28"/>\n          <stop offset="100%" stop-color="#b20000"/>\n        </linearGradient>\n        <linearGradient id="marioYellow" x1="0%" y1="0%" x2="100%" y2="100%">\n          <stop offset="0%" stop-color="#ffe600"/>\n          <stop offset="100%" stop-color="#ffb800"/>\n        </linearGradient>\n        <filter id="marioShadow" x="-20%" y="-20%" width="140%" height="140%">\n          <feDropShadow dx="0" dy="3" stdDeviation="2" flood-color="#000" flood-opacity="0.7"/>\n        </filter>\n      </defs>\n      <g filter="url(#marioShadow)">\n        <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle"\n          font-size="54" font-family="Impact, Arial Black, Arial, Helvetica, sans-serif"\n          fill="url(#marioShadow)" stroke="url(#marioYellow)" stroke-width="5" letter-spacing="10">\n          UTM\n        </text>\n      </g>\n      <text x="50%" y="54%" dominant-baseline="middle" text-anchor="middle"\n        font-size="54" font-family="Impact, Arial Black, Arial, Helvetica, sans-serif"\n        fill="none" stroke="#fff" stroke-width="2" opacity="0.7" letter-spacing="10">\n        UTM\n      </text>\n    </svg>\n    ',e=new window.Image;e.onload=()=>{this._marioLogoLoaded=!0,this._marioLogoImg=e},e.src="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(t)))}if(this._marioLogoImg&&this._marioLogoLoaded){let t=(this.world.W-220)/2,e=10;this.ctx.drawImage(this._marioLogoImg,t,e,220,70),this.world.setFont("origami_light"),this.world.write("Univ tecnologica de morelia",this.world.W/2,80,"center")}this.displaySelection(),this.world.ctx.fillStyle="rgba(0,0,0,0.6)",this.world.ctx.fillRect(0,this.world.H-50,this.world.W,33),this.world.setFont("origami_light"),this.world.write("Mau gei",this.world.W/2,this.world.H-46,"center"),this.world.write("[x] para Confirmar",this.world.W/2,this.world.H-30,"center")},menu.displaySelection=function(){for(i in this.ctx.fillStyle="#82769e",this.world.drawBox("box",this.select_pos.x-(this.texteMax+60)/2,this.select_pos.y-16,this.texteMax+60,20*this.button.length+20),this.button){i==this.selection?this.world.setFont("origami_light"):this.world.setFont("origami_dark");let t=this.button[i].name;this.world.write(t,this.select_pos.x,this.select_pos.y+20*i,"center")}this.cursor_phase+=.1,this.cursor_phase>1/Math.sin(.2)&&(this.cursor_phase=-1);let t=this.select_pos.x+2*Math.sin(this.cursor_phase)-20;this.world.ctx.drawImage(this.cursor,t-10*this.button[this.selection].name.length/2,this.select_pos.y+20*this.selection-2)},menu.animatedBackground=function(){this.offset.x+=.8,this.offset.y+=.6,this.offset.x>63&&(this.offset.x=0),this.offset.y>63&&(this.offset.y=0);let t=this.world.ctx;t.save(),t.translate(this.offset.x,this.offset.y),t.fillStyle=this.pattern,t.fillRect(-this.offset.x,-this.offset.y,this.world.W,this.world.H),t.restore()};let levels=new Scene("levels");levels.keyEvents=function(t){this.world.keys.KeyE&&(this.world.assets.audio.selection.audio.play(),this.world.startScene("menu")),this.world.keys.ArrowDown&&this.selection+5<this.world.mapsMax&&(this.world.assets.audio.selection.audio.play(),this.selection+=5),this.world.keys.ArrowUp&&this.selection-5>=0&&(this.world.assets.audio.selection.audio.play(),this.selection-=5),this.world.keys.ArrowRight&&this.selection+1<this.world.mapsMax&&(this.world.assets.audio.selection.audio.play(),this.selection+=1),this.world.keys.ArrowLeft&&this.selection-1>=0&&(this.world.assets.audio.selection.audio.play(),this.selection-=1),this.world.keys.KeyX&&(this.world.assets.audio.selection.audio.play(),this.world.current_level=this.selection+1,this.world.startScene("inGame"))},levels.init=function(){this.init_once=!0,this.selection=0,this.scale=0},levels.render=function(){this.world.clear("black"),this.scale+=.1,this.scale>1/Math.sin(.2)&&(this.scale=-1);let t=2*Math.sin(this.scale);this.ctx.fillStyle="#82769e",this.world.drawBox("box",16,16,this.world.W-32,this.world.H-46-32),this.world.setFont("origami_light"),this.world.setFont("origami_dark");let e=Math.min(this.world.mapsMax,20);for(let i=0;i<e;i++){let e=i+20*Math.floor(this.selection/20),s=32+40*Math.floor(i%5),o=32+40*Math.floor(i/5);e==this.selection?(this.world.setFont("origami_light"),this.world.drawBox("selection",s-t/2,o-t/2,24+t,24+t)):(this.world.setFont("origami_dark"),this.world.drawBox("flat_frame",s,o,24,24)),this.world.write((e+1).toString(),s+13,o+8,"center")}this.world.ctx.fillStyle="rgba(0,0,0,0.6)",this.world.ctx.fillRect(0,this.world.H-50,this.world.W,33),this.world.setFont("origami_light"),this.world.write("Flechas para seleccionar",this.world.W/2,this.world.H-46,"center"),this.world.write("[x] para confirmar, [E] para salir",this.world.W/2,this.world.H-30,"center")};let inGame=new Scene("inGame");inGame.keyEvents=function(t){this.world.keys.KeyE&&this.userInput&&this.transition.start(0,Math.max(this.world.W/2,this.world.H/2),()=>{this.world.startScene("menu")}),this.world.keys.KeyR&&this.userInput&&this.transition.start(0,Math.max(this.world.W/2,this.world.H/2),()=>{this.world.startScene("inGame")})},inGame.init=function(){this.won=!1,this.userInput=!0,this.world.initMap("map_"+this.world.current_level),this.cats=[];this.effects=[],this.transition={scene:this,active:!0,state:0,value:0,duration:500,start:0,from:0,to:Math.max(this.world.W,this.world.H),start:function(t,e,i){this.scene.userInput=!1,this.active=!0,this.from=t,this.start_time=new Date,this.to=e,this.callback=i},update:function(){let t=new Date-this.start_time;t<this.duration?this.value=Util.easeInOutQuad(t,this.from,this.to-this.from,this.duration):(this.active=!1,this.scene.userInput=!0,void 0!==this.callback&&this.callback())},render:function(){this.scene.ctx.fillStyle="black",this.scene.ctx.fillRect(0,0,this.scene.world.W,this.value),this.scene.ctx.fillRect(0,this.scene.world.H,this.scene.world.W,-this.value),this.scene.ctx.fillRect(0,0,this.value,this.scene.world.H),this.scene.ctx.fillRect(this.scene.world.W,0,-this.value,this.scene.world.H)}},this.transition.start(Math.max(this.world.W/2,this.world.H/2),0,()=>{this.world.findTile(3,7).forEach(t=>{this.addCat(t.x,t.y)})})},inGame.addCat=function(t,e){let i=new Cat(this,t,e);i.setSprite({image:"player_sprite",size:{x:18,y:18}}),i.sprite.addAnimation("idle",[0,1,2,3,4,5,6,7,8,9,10,11]),i.sprite.speed=.2,i.sprite.offset.y=-3;let s=new Effect(this,{image:"spawn_effect",frames:[0,1,2,3,4,5,6,7,8,9,10,11,12],size:{x:20,y:40}},t,e-1,()=>{this.cats.push(i),this.world.assets.audio.apparition.audio.play()});s.trigger=4,this.effects.push(s)},inGame.render=function(){this.control(),this.world.renderMap();for(let t=this.cats.length;t--;)this.cats[t].sprite.animate("idle"),this.ctx.drawImage(this.world.assets.image.shadow.image,this.cats[t].body.position.x,this.cats[t].body.position.y+2),this.cats[t].display(),this.cats[t].translation();for(let t=this.effects.length;t--;)this.effects[t].render();this.transition.active&&(this.transition.update(),this.transition.render())},inGame.control=function(){if(0==this.userInput)return!1;this.world.keys.ArrowUp&&this.moveCats(0,-1),this.world.keys.ArrowDown&&this.moveCats(0,1),this.world.keys.ArrowLeft&&this.moveCats(-1,0),this.world.keys.ArrowRight&&this.moveCats(1,0)},inGame.moveCats=function(t,e){if(!this.cats.every(t=>0==t.inTranslation))return!1;this.cats.forEach(i=>!1!==i.canBeControlled&&(!i.isDead&&void i.move(t,e))),this.collisionCats(),this.cats.forEach(t=>{t.applyMove()})},inGame.collisionCats=function(){let t=!0;for(;!0===t;)t=!1,this.cats.forEach(e=>{e.checkOthers()&&(e.target=e.old_position.copy(),t=!0)})},inGame.checkWin=function(){if(0===this.cats.length){this.userInput=!1;let t=Math.floor(10*Math.random())+1,e=Math.floor(10*Math.random())+1,i=["+","-","*"][Math.floor(3*Math.random())],s=`${t} ${{"+":"mas","-":"menos","*":"por"}[i]} ${e}`,o=`${t} ${i} ${e}`,a=null,r="",n=!1,h=()=>{this.ctx.fillStyle="rgba(0,0,0,0.85)",this.ctx.fillRect(0,0,this.world.W,this.world.H),this.world.setFont("origami_light"),this.world.write("Resuelve el ejercicio",this.world.W/2,70,"center"),this.world.write("para continuar ",this.world.W/2,80,"center"),this.world.write(s+" = ?",this.world.W/2,100,"center"),this.world.write("Tu respuesta: "+r,this.world.W/2,130,"center"),this.world.write("[Enter] para enviar",this.world.W/2,170,"center"),n&&(this.ctx.fillStyle="#ff3c28",this.world.write("Incorrecto, intenta de nuevo.",this.world.W/2,200,"center"))},l=this.render;this.render=function(){this.world.renderMap();for(let t=this.cats.length;t--;)this.cats[t].sprite.animate("idle"),this.ctx.drawImage(this.world.assets.image.shadow.image,this.cats[t].body.position.x,this.cats[t].body.position.y+2),this.cats[t].display(),this.cats[t].translation();for(let t=this.effects.length;t--;)this.effects[t].render();this.transition.active&&(this.transition.update(),this.transition.render()),h()};let c=t=>{t.key>="0"&&t.key<="9"&&(r+=t.key,n=!1),"Backspace"===t.key&&(r=r.slice(0,-1),n=!1),"Enter"===t.key&&r.length>0&&fetch(`https://api.mathjs.org/v4/?expr=${encodeURIComponent(o)}`).then(t=>t.text()).then(t=>{a=t.trim(),r===a?(window.removeEventListener("keydown",c),this.render=l,this.userInput=!0,this.transition.start(0,Math.max(this.world.W/2,this.world.H/2),()=>{this.world.startScene("inGame")})):(n=!0,r="")})};return void window.addEventListener("keydown",c)}!0===this.cats.every(t=>"exit"==this.world.getTile(3,t.target.x,t.target.y).name)&&this.cats.length>=this.world.findTile(3,8).length&&!this.won&&(this.won=!0,this.world.assets.audio.jingle.audio.play(),void 0!==this.world.maps["map_"+(this.world.current_level+1)]?this.transition.start(0,Math.max(this.world.W/2,this.world.H/2),()=>{this.world.current_level+=1,this.world.startScene("inGame")}):this.transition.start(0,Math.max(this.world.W/2,this.world.H/2),()=>{this.world.startScene("menu")}))};class Effect extends Entity{constructor(t,e,i,s,o){super(t,i*t.world.tile_size,s*t.world.tile_size),this.setSprite(e),this.sprite.addAnimation("full",e.frames),this.sprite.speed=.4,this.sprite.offset.y=-3,this.trigger=e.frames.length,this.callback=o||void 0}render(){this.sprite.current_frame+1===this.trigger&&void 0!==this.callback&&(this.callback(),this.callback=void 0),this.sprite.current_frame+1===this.sprite.animations[this.sprite.current_animation].length&&this.scene.effects.splice(this.scene.effects.indexOf(this),1),this.sprite.animate("full"),this.display()}}class Cat extends Entity{constructor(t,e,i){super(t,e*t.world.tile_size,i*t.world.tile_size),this.old_position=new Vector(e,i),this.target=new Vector(e,i),this.canBeControlled=!0,this.inTranslation=!1,this.lastDirection=new Vector(0,0),this.isDead=!1,this.transition={start:new Date,duration:300,type:Util.easeInOutQuad,start_pos:new Vector}}translation(){if(this.inTranslation){let t=new Date-this.transition.start;if(t<this.transition.duration){let e=this.transition.type(t,this.transition.start_pos.x,this.transition.target.x-this.transition.start_pos.x,this.transition.duration),i=this.transition.type(t,this.transition.start_pos.y,this.transition.target.y-this.transition.start_pos.y,this.transition.duration);this.body.position=new Vector(e,i)}else{this.old_position=this.target.copy();let t=this.target.copy();if(t.mult(this.world.tile_size),this.body.position=t,this.inTranslation=!1,this.isDead){let t={image:"water_splash",frames:[0,1,2,3,4,5,6,7,8],size:{x:20,y:32}},e=new Effect(this.scene,t,this.target.x,this.target.y-1,()=>{this.scene.cats.splice(this.scene.cats.indexOf(this),1),this.world.assets.audio.splash.audio.play(),this.scene.checkWin()});e.sprite.offset.y=0,e.trigger=2,this.scene.effects.push(e)}if(!1===this.canBeControlled)this.move(this.lastDirection.x,this.lastDirection.y),this.scene.collisionCats(),this.applyMove();else{switch(this.world.assets.audio.mouvement.audio.play(),this.world.getTile(3,this.target.x,this.target.y).name){case"arrowRight":this.move(1,0),this.scene.collisionCats(),this.applyMove();break;case"arrowLeft":this.move(-1,0),this.scene.collisionCats(),this.applyMove();break;case"arrowUp":this.move(0,-1),this.scene.collisionCats(),this.applyMove();break;case"arrowDown":this.move(0,1),this.scene.collisionCats(),this.applyMove()}}this.scene.checkWin()}}}move(t,e){this.target=this.old_position.copy();let i=new Vector(t,e),s=this.target.copy();s.add(i);let o=this.world.terrain.layers,a=o.map(t=>{let e=o.indexOf(t);return this.world.getTile(e,s.x,s.y)});if(1==a.every(t=>0==t?0==t:!1===t.collision)&&this.target.add(i),"ice"===a[3].name)return this.canBeControlled=!1,this.transition.type=Util.linearTween,this.transition.duration=100,!1;if("trap"===a[3].name){let t={image:"dust_effect",frames:[0,1,2,3,4,5,6,7,8,9,10,11,12],size:{x:32,y:32}},e=new Effect(this.scene,t,this.target.x,this.target.y);return this.scene.effects.push(e),this.world.assets.audio.eboulement.audio.play(),this.world.terrain.layers[3].geometry[s.y][s.x]=10,this.world.terrainCache(this.world.terrain.layers[3]),!1}return"ground"!==a[1].name?(this.transition.type=Util.easeInOutQuad,this.transition.duration=200,this.isDead=!0,!1):(this.canBeControlled=!0,this.transition.type=Util.easeInOutQuad,this.transition.duration=200,!1)}applyMove(){if(this.old_position.x===this.target.x&&this.old_position.y===this.target.y)return this.canBeControlled=!0,this.world.assets.audio.bump.audio.play(),!1;this.lastDirection=new Vector(this.target.x-this.old_position.x,this.target.y-this.old_position.y),this.shouldMove=!1,this.transition.start_pos=this.old_position.copy(),this.transition.start_pos.mult(this.world.tile_size),this.transition.target=this.target.copy(),this.transition.target.mult(this.world.tile_size),this.transition.start=new Date,this.inTranslation=!0}checkOthers(){let t=this.scene.cats,e=!1;for(let i=0;i<t.length;i++)if(this!==t[i]&&t[i].target.x===this.target.x&&t[i].target.y===this.target.y){e=!0;break}return e}}let controls=new Scene("controls");controls.keyEvents=function(t){this.world.keys.KeyE&&this.world.startScene("menu")},controls.init=function(){this.loop=!1,this.controls=this.world.assets.image.controls.image},controls.render=function(){this.world.clear("black"),this.ctx.drawImage(this.controls,0,0),this.world.setFont("origami_light"),this.world.write("[E] para salir",this.world.W/2,this.world.H-46,"center")};let game=new Diorama(parameters);game.current_level=1,game.addScene(menu),game.addScene(levels),game.addScene(controls),game.addScene(inGame),game.ready(),game.soundLevel(.2),game.fullScreen()</script></body></html>